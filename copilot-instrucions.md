# Copilot 用開発指示書 (copilot-instrucions.md)

以下はこのリポジトリで Copilot（自動化エージェント）や開発者が守るべきルールと方針です。

## 前提条件
- 回答は必ず日本語で行うこと。
- 大規模な変更（例: 200行以上の差分や複数ファイルにまたがる大きな設計変更）を行う前には、まず変更計画（概要、影響範囲、ロールバック手順、テスト計画）を提案し、承認を得ること。

## 修正方針
- 目的: 週次カレンダーの読み込み遅延改善をはじめ、アプリ全体のパフォーマンスと保守性を向上させる。
- 原則:
  - 小さく、段階的に変更する。可能な限り既存の API/インタフェースを壊さない。
  - 変更前に影響範囲を明確化する（どのコンポーネント／composable／サービスが影響を受けるか）。
  - 既存のユニット／統合テストに追加する形でテストを追加する。
  - デバッグ用 UI はデフォルトで無効化／開発環境のみ表示する。

- コード規約:
  - TypeScript を利用。型定義を適切に行う。
  - 既存のプロジェクトスタイル（命名規則／インデント）に従うこと。

## 技術スタック（エコシステム）
- フレームワーク: Nuxt 3（Vue 3 Composition API）
- UI: Vuetify（v-table/v-btn等が使用されている）
- データ層: Firebase Firestore
- 言語: TypeScript
- テスト: プロジェクト標準のテストフレームワーク（未明示）を推奨。Jest/Vitest のいずれかを推奨。
- ビルド/ラン: npm / nuxi (nuxt dev)

## ディレクトリ構成
- `components/` - Vue コンポーネント
  - `Calendar/` - カレンダー用のコンポーネント（WeeklyView, MonthlyView 等）
- `composables/` - Vue composables（useCalendar.ts, firebase 用 composables 等）
- `services/` - ビジネスロジックや Firestore 呼び出しをまとめたサービス
- `pages/` - ルーティングページ
- `plugins/` - Nuxt プラグイン（Firebase 初期化等）
- `types/` - 型定義ファイル
- `docs/` - ドキュメント

開発時はファイルの変更がどの領域に影響するかを常に意識する。

## アーキテクチャ・設計指針
- データ取得責務の分離:
  - Firestore へのクエリは `services/` と `composables/firebase` に限定する。
  - コンポーネントは `composables` や `services` を呼び出して表示に専念する。
- キャッシュ戦略:
  - マスターデータ（users, holidays 等）は TTL を設けたメモリキャッシュ（Nuxt useState）を利用。
  - 動的データ（events 等）は日付レンジキャッシュや短い TTL を検討。
  - キャッシュの無効化（forceRefresh）や開発用キャッシュクリアを用意する。
- プロファイリング・デバッグ:
  - Firestore クエリのプロファイラを導入し、回数・時間をログに残す。
  - デバッグ UI は開発モードのみ有効化。
- エラーハンドリング:
  - Firestore エラーはログ出力し、可能ならばフォールバック（stale cache）を返す。
  - ユーザーには操作に影響がある場合だけ UI レベルでエラーメッセージを表示する。
- スケーリング:
  - クエリ回数削減（バッチ化、範囲取得）を優先。
  - IN クエリの要素数制限には注意（Firestore の制限を考慮して分割実行や別戦略を採用）。

## テスト方針
- カバレッジは80%を目指す。
- 単体テスト:
  - `composables` と `services` のユニットテストを優先（Firestore への依存はスタブ/モック化）。
- 結合テスト:
  - 主要な画面（カレンダー表示）について E2E テストを用意（Playwright / Cypress 推奨）。
- 性能テスト:
  - 変更前後で Firestore クエリ回数と平均応答時間を比較するベンチを用意。
- テスト実行:
  - CI にテストとカバレッジ測定を組み込む（PR ごとに実行）。

## アンチパターン
- 多重クエリ（同一データを複数から並行で取得する）
  - 解決: in-flight deduplication または一元取得
- クライアント側で過剰フィルタリングして複数回の往復を発生させる
  - 解決: 日付範囲などでまとめて取得しクライアントで最小限フィルタ
- キャッシュ無効化が手動のみで自動更新がない
  - 解決: TTL とイベント駆動のキャッシュクリア
- クエリごとに大量の IN 条件を投げる
  - 解決: IN チャンク化、または別のデータモデリングを検討（マップ、デュープリケート索引など）

このファイルはプロジェクトのルールや Copilot の振る舞いを統一するためのドキュメントです。必要に応じて更新してください。

## 今後の作業方針（内容は随時更新）

### **フェーズ1: 即効性重視**
- 施策1-1 IN句エラー解決
- 施策1-2 daily_user_optionsキャッシュ

**フェーズ2: 根本解決**
- 施策2-1 eventsクエリ統合
