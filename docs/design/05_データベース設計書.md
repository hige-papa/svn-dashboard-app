# データベース設計書

## Tascal（タスカル） - 社員タスク管理・カレンダーアプリケーション

| 項目 | 内容 |
|------|------|
| ドキュメントID | DB-001 |
| バージョン | 1.0 |
| 作成日 | 2026-02-26 |
| プロジェクト名 | SVN Dashboard App (Tascal) |
| ステータス | 初版 |

---

## 1. データベース概要

### 1.1 データベース種別

| 項目 | 内容 |
|------|------|
| サービス | Google Cloud Firestore |
| 種別 | NoSQL ドキュメントデータベース |
| リージョン | asia-northeast1（東京） |
| データベース名 | (default) |
| モード | ネイティブモード |

### 1.2 データモデル方針

- Firestoreのドキュメント指向モデルに準拠
- コレクション/ドキュメント構造を採用
- サブコレクションは Wiki記事の履歴のみ使用
- リレーションはドキュメントID参照で表現
- デノーマライゼーションにより読み取り性能を重視

---

## 2. コレクション設計

### 2.1 コレクション一覧

| No | コレクション名 | 概要 | ドキュメント数目安 |
|----|--------------|------|------------------|
| 1 | events | カレンダーイベント | 多（数千〜） |
| 2 | event_instances | 繰り返しイベントインスタンス | 多 |
| 3 | users | ユーザープロフィール | 少（数十〜百） |
| 4 | holidays | 祝日マスター | 少（数十） |
| 5 | daily_user_options | 日別ユーザーオプション | 多 |
| 6 | facility | 施設マスター | 少 |
| 7 | equipment | 設備マスター | 少 |
| 8 | team | チームマスター | 少 |
| 9 | section | 部署マスター | 少 |
| 10 | wikiArticles | Wiki記事 | 中 |
| 11 | wikiArticles/{id}/histories | Wiki記事履歴 | 中 |
| 12 | lunchShuffle | ランチシャッフルデータ | 少 |
| 13 | menus | メニュー定義 | 少 |
| 14 | ownCompany | 自社情報 | 1件 |

---

## 3. コレクション詳細

### 3.1 events コレクション

カレンダーイベントを格納するメインコレクション。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | Firestore自動生成 |
| title | string | はい | イベントタイトル | |
| description | string | いいえ | 詳細説明 | |
| dateType | string | はい | 日付種別 | 'single' / 'range' / 'recurring' |
| date | string | 条件付き | 予定日 | YYYY-MM-DD形式 |
| startDate | string | 条件付き | 開始日 | YYYY-MM-DD形式 |
| endDate | string | 条件付き | 終了日 | YYYY-MM-DD形式 |
| startTime | string | はい | 開始時刻 | HH:mm形式 |
| endTime | string | はい | 終了時刻 | HH:mm形式 |
| eventType | string | はい | イベント種別 | 'meeting' / 'focus' / 'away' / 'other' / 'vacation' / 'normal' |
| participantIds | array\<string\> | いいえ | 参加者UID配列 | usersコレクションのUID |
| facilityIds | array\<string\> | いいえ | 施設ID配列 | facilityコレクションのID |
| equipmentIds | array\<string\> | いいえ | 設備ID配列 | equipmentコレクションのID |
| isPrivate | boolean | いいえ | プライベートフラグ | デフォルト: false |
| masterId | string | いいえ | マスターイベントID | 範囲/繰り返し予定のグループ識別子 |
| recurrenceRule | map | いいえ | 繰り返しルール | recurringの場合のみ |
| createdAt | timestamp | 自動 | 作成日時 | サーバータイムスタンプ |
| updatedAt | timestamp | 自動 | 更新日時 | サーバータイムスタンプ |
| createdBy | string | 自動 | 作成者UID | |
| updatedBy | string | 自動 | 更新者UID | |

#### recurrenceRule の構造

| フィールド名 | 型 | 説明 |
|-------------|---|------|
| pattern | string | 'daily' / 'weekdays' / 'weekly' / 'monthly' / 'yearly' / 'custom' |
| endType | string | 'never' / 'date' / 'count' |
| endDate | string | 終了日（YYYY-MM-DD） |
| count | number | 繰り返し回数 |
| interval | number | 間隔（週/月単位） |
| selectedWeekdays | array\<number\> | 選択曜日（0=日〜6=土） |
| monthlyType | string | 'date' / 'weekday' |

### 3.2 event_instances コレクション

繰り返しイベントの個別インスタンスを格納。

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| id | string | 自動 | ドキュメントID |
| masterId | string | はい | マスターイベントID |
| instanceDate | string | はい | インスタンス日付（YYYY-MM-DD） |
| overrides | map | いいえ | 個別上書き情報 |
| createdAt | timestamp | 自動 | 作成日時 |
| updatedAt | timestamp | 自動 | 更新日時 |

### 3.3 users コレクション

ユーザープロフィール情報を格納。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| uid | string | はい | Firebase Auth UID | ドキュメントIDと同一 |
| displayName | string | はい | 表示名（日本語） | |
| displayNameEng | string | はい | 表示名（英語） | |
| color | string | はい | カレンダー表示色 | カラーコード |
| code | string | はい | 社員コード | |
| email | string | いいえ | メールアドレス | |
| phone | string | いいえ | 電話番号 | |
| department | string | いいえ | 部署名 | |
| role | string | いいえ | 権限 | 'admin' / 'user' / 'viewer' |
| status | string | いいえ | ステータス | 'active' / 'inactive' |
| bio | string | いいえ | 自己紹介 | |
| avatar | string | いいえ | アバター画像URL | |
| notifications | map | いいえ | 通知設定 | {email, calendar, system} |
| visible | boolean | はい | カレンダー表示可否 | |
| extension | string | いいえ | 内線番号 | |
| sortOrder | string | いいえ | 表示順 | |
| lastLogin | timestamp | いいえ | 最終ログイン日時 | |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

### 3.4 holidays コレクション

祝日マスターデータ。

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| id | string | 自動 | ドキュメントID |
| date | string | はい | 祝日日付（YYYY-MM-DD） |
| name | string | はい | 祝日名 |
| createdAt | timestamp | 自動 | 作成日時 |
| updatedAt | timestamp | 自動 | 更新日時 |

### 3.5 daily_user_options コレクション

日別のユーザー勤怠・参加情報。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| uid | string | はい | ユーザーUID | |
| date | string | はい | 対象日付 | YYYY-MM-DD形式 |
| workStyle | string | はい | 勤務形態 | 'office' / 'remote' / 'out' / 'vacation' / 'pending' |
| lunchParticipation | string | はい | ランチ参加 | 'possible' / 'impossible' / 'pending' |
| dinnerParticipation | string | はい | 夕食参加 | 'possible' / 'impossible' / 'pending' |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

**ユニーク制約**: uid + date の組み合わせで一意（アプリケーション側で制御）

### 3.6 facility コレクション

施設マスターデータ。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| name | string | はい | 施設名 | |
| code | string | はい | 施設コード | |
| description | string | いいえ | 説明 | |
| capacity | number | いいえ | 定員 | null許可 |
| category | string | はい | カテゴリ | |
| imageUrl | string | いいえ | 画像URL | |
| status | string | はい | ステータス | 'available' / 'in_use' / 'maintenance' |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

### 3.7 equipment コレクション

設備マスターデータ。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| name | string | はい | 設備名 | |
| code | string | はい | 設備コード | |
| description | string | いいえ | 説明 | |
| capacity | number | いいえ | 数量 | null許可 |
| category | string | はい | カテゴリ | |
| imageUrl | string | いいえ | 画像URL | |
| status | string | はい | ステータス | 'available' / 'in_use' / 'maintenance' |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

### 3.8 team コレクション

チームマスターデータ。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| name | string | はい | チーム名 | |
| code | string | はい | チームコード | |
| description | string | いいえ | 説明 | |
| category | string | はい | カテゴリ | |
| imageUrl | string | いいえ | 画像URL | |
| status | string | はい | ステータス | 'available' / 'in_use' / 'maintenance' |
| memberIds | array\<string\> | いいえ | メンバーUID配列 | usersのUID |
| members | array\<string\> | いいえ | メンバー名配列 | 表示用 |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

### 3.9 section コレクション

部署マスターデータ。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| name | string | はい | 部署名 | |
| code | string | はい | 部署コード | |
| description | string | いいえ | 説明 | |
| category | string | はい | カテゴリ | |
| imageUrl | string | いいえ | 画像URL | |
| status | string | はい | ステータス | 'available' / 'in_use' / 'maintenance' |
| createdAt | timestamp | 自動 | 作成日時 | |
| updatedAt | timestamp | 自動 | 更新日時 | |

### 3.10 wikiArticles コレクション

Wiki記事データ。

| フィールド名 | 型 | 必須 | 説明 | 備考 |
|-------------|---|------|------|------|
| id | string | 自動 | ドキュメントID | |
| title | string | はい | 記事タイトル | |
| summary | string | はい | 概要 | |
| content | string | はい | 本文（Markdown） | |
| author | string | はい | 著者名 | |
| department | string | はい | 所属部署 | |
| category | map | いいえ | カテゴリ | Tag型: {text, color} |
| tags | array\<map\> | いいえ | タグ配列 | Tag型: [{text, color}] |
| image | string | いいえ | サムネイル画像URL | |
| status | string | はい | ステータス | 'published' / 'draft' / 'archived' |
| views | number | はい | 閲覧数 | デフォルト: 0 |
| version | number | はい | バージョン番号 | デフォルト: 1 |
| createdAt | string | 自動 | 作成日時 | ISO文字列 |
| updatedAt | string | 自動 | 更新日時 | ISO文字列 |

#### サブコレクション: wikiArticles/{id}/histories

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| snapshot | map | はい | 記事のスナップショット（WikiArticle全体） |
| version | number | はい | バージョン番号 |
| createdAt | string | はい | 作成日時 |
| updatedAt | string | はい | 更新日時 |

### 3.11 lunchShuffle コレクション

ランチシャッフルデータ。

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| id | string | 自動 | ドキュメントID |
| participants | array\<string\> | はい | 参加者リスト（固定20要素） |
| teams | string | はい | チーム分け結果（JSON文字列） |
| resultMessage | string | はい | 結果メッセージ |
| lastShuffledAt | string | いいえ | 最終シャッフル日時 |
| lastShuffledBy | string | いいえ | 最終シャッフル実行者 |
| updatedAt | string | はい | 更新日時 |
| updatedBy | string | はい | 更新者 |

### 3.12 menus コレクション

メニュー定義。

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| id | string | 自動 | ドキュメントID |
| label | string | はい | メニュー表示名 |
| icon | string | はい | アイコン名 |
| isActive | boolean | はい | 有効フラグ |
| path | string | はい | リンクパス |
| section | string | はい | セクション名 |
| roles | array\<string\> | はい | 表示可能ロール |

### 3.13 ownCompany コレクション

自社情報。

| フィールド名 | 型 | 必須 | 説明 |
|-------------|---|------|------|
| id | string | 自動 | ドキュメントID |
| displayName | string | はい | 会社名 |
| code | string | はい | 会社コード |
| avatar | string | いいえ | ロゴ画像URL |

---

## 4. インデックス設計

### 4.1 複合インデックス一覧

以下の複合インデックスを `firestore.indexes.json` で定義。

| No | コレクション | フィールド1 | 順序1 | フィールド2 | 順序2 | 用途 |
|----|------------|-----------|------|-----------|------|------|
| 1 | event_instances | masterId | ASC | instanceDate | ASC | マスターID別インスタンス日付順取得 |
| 2 | events | dateType | ASC | startDate | ASC | 日付種別・開始日でのイベント検索 |
| 3 | events | equipmentIds | CONTAINS | dateType + 他 | ASC | 設備別イベント検索 |
| 4 | events | facilityIds | CONTAINS | dateType + 他 | ASC | 施設別イベント検索 |
| 5 | events | participantIds | CONTAINS | date | ASC | 参加者別・日付順イベント検索 |
| 6 | events | participantIds | CONTAINS | dateType | ASC | 参加者別・種別イベント検索 |
| 7 | users | status | ASC | displayName | ASC | ステータス別・名前順ユーザー一覧 |

### 4.2 単一フィールドインデックス

Firestoreはデフォルトで各フィールドに単一フィールドインデックスを自動作成する。
以下の主要フィールドが自動インデックス対象。

| コレクション | フィールド | 主な用途 |
|------------|-----------|---------|
| events | date | 日付によるイベント検索 |
| events | masterId | マスターID検索 |
| daily_user_options | uid | ユーザー別検索 |
| daily_user_options | date | 日付別検索 |
| users | status | ステータス別検索 |
| wikiArticles | status | ステータス別記事検索 |

---

## 5. セキュリティルール

### 5.1 Firestoreセキュリティルール

```
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

#### ルール概要

| ルール | 条件 | 対象 |
|--------|------|------|
| 読み取り許可 | Firebase Authで認証済みであること | 全コレクション |
| 書き込み許可 | Firebase Authで認証済みであること | 全コレクション |
| 未認証アクセス | 拒否 | 全コレクション |

---

## 6. データ参照関係

```
users (uid)
  │
  ├──◁ events.participantIds[]        参加者
  ├──◁ daily_user_options.uid          日別オプション所有者
  ├──◁ team.memberIds[]               チームメンバー
  ├──◁ lunchShuffle.lastShuffledBy     シャッフル実行者
  └──◁ wikiArticles.author             記事著者

facility (id)
  └──◁ events.facilityIds[]           イベント使用施設

equipment (id)
  └──◁ events.equipmentIds[]          イベント使用設備

events (id)
  ├──◁ events.masterId                マスター・インスタンス関係
  └──◁ event_instances.masterId       繰り返しインスタンス

wikiArticles (id)
  └──▷ wikiArticles/{id}/histories    記事履歴（サブコレクション）
```

---

## 7. データ容量見積もり

| コレクション | 1ドキュメント平均サイズ | 年間ドキュメント数見積 | 年間データ量 |
|------------|---------------------|-------------------|-----------|
| events | ~500 bytes | ~10,000 | ~5 MB |
| users | ~1 KB | ~100 | ~100 KB |
| daily_user_options | ~200 bytes | ~25,000 | ~5 MB |
| holidays | ~100 bytes | ~20 | ~2 KB |
| facility | ~500 bytes | ~20 | ~10 KB |
| equipment | ~500 bytes | ~50 | ~25 KB |
| team | ~500 bytes | ~20 | ~10 KB |
| section | ~500 bytes | ~10 | ~5 KB |
| wikiArticles | ~5 KB | ~200 | ~1 MB |

---

## 8. キャッシュ設計

### 8.1 Firebase Storage キャッシュ

| キャッシュ名 | パス | 形式 | 用途 |
|------------|------|------|------|
| 週別イベントキャッシュ | `calendar-cache/{year}-{week}-cache.json` | JSON | 週別イベントデータの高速読み込み |

### 8.2 アプリケーションキャッシュ

| キャッシュ名 | TTL | 保存先 | キー形式 |
|------------|-----|--------|---------|
| ユーザーマスター | 10時間 | useState | 'users' |
| 祝日マスター | 10時間 | useState | 'holidays' |
| 施設マスター | 10時間 | useState | 'facilities' |
| 設備マスター | 10時間 | useState | 'equipments' |
| 日別オプション | 1時間 | useState | '{startDate}_{endDate}' |
| カレンダー位置 | 永続 | localStorage | 'calendar-position' |
| カレンダービュー | 永続 | localStorage | 'calendar-view' |
